# 图片上传参数传递使用指南

## 概述

本项目的图片上传功能支持在上传文件时附带传送其他业务参数，这些参数会通过 FormData 一起发送到服务器，便于后端进行分类处理、权限校验、业务逻辑判断等操作。

## 核心功能

### 1. 通用参数生成函数

```typescript
const generateUploadParams = (type: 'cover' | 'display', extraParams: Record<string, any> = {}) => {
  const baseParams = {
    type: type === 'cover' ? 'activity_cover' : 'activity_display',
    category: 'activity',
    activityName: formData.name || '',
    uploadTime: new Date().toISOString(),
    uploadUser: 'current_user',
    ...extraParams
  }

  // 根据类型添加特定参数
  if (type === 'cover') {
    return {
      ...baseParams,
      maxWidth: '1920',
      maxHeight: '1080',
      usage: 'activity_cover'
    }
  } else {
    return {
      ...baseParams,
      index: formData.displayImages.length.toString(),
      description: `活动展示图片${formData.displayImages.length + 1}`,
      activityStartTime: formData.startTime ? formData.startTime.toString() : '',
      activityEndTime: formData.endTime ? formData.endTime.toString() : ''
    }
  }
}
```

### 2. 封面上传示例

```typescript
const handleUpload = async (option: any): Promise<void> => {
  const file = option.file
  const uploadData = new FormData()

  // 添加文件
  uploadData.append('file', file)

  // 使用通用函数生成参数
  const uploadParams = generateUploadParams('cover', {
    // 可以在这里添加封面特有的参数
    priority: 'high', // 优先级
    compress: 'true', // 是否压缩
    watermark: 'false' // 是否添加水印
  })

  // 将所有参数添加到FormData
  Object.entries(uploadParams).forEach(([key, value]) => {
    uploadData.append(key, value.toString())
  })

  try {
    const response = await imageService.uploadImage(uploadData)
    // 处理响应...
  } catch (error) {
    // 错误处理...
  }
}
```

### 3. 展示图片上传示例

```typescript
const handleDisplayImageUpload = async (option: any): Promise<void> => {
  const file = option.file
  const uploadData = new FormData()

  // 添加文件
  uploadData.append('file', file)

  // 使用通用函数生成参数
  const uploadParams = generateUploadParams('display', {
    // 可以在这里添加展示图片特有的参数
    allowResize: 'true', // 允许缩放
    quality: '85', // 图片质量
    tags: '活动,展示', // 图片标签
    originalName: file.name // 原始文件名
  })

  // 将所有参数添加到FormData（过滤空值）
  Object.entries(uploadParams).forEach(([key, value]) => {
    if (value !== null && value !== undefined && value !== '') {
      uploadData.append(key, value.toString())
    }
  })

  try {
    const response = await imageService.uploadImage(uploadData)
    // 处理响应...
  } catch (error) {
    // 错误处理...
  }
}
```

## 可传递的参数类型

### 基础参数

- `type`: 图片类型标识（activity_cover、activity_display等）
- `category`: 业务分类（activity、article、user等）
- `uploadTime`: 上传时间（ISO格式）
- `uploadUser`: 上传用户标识

### 业务参数

- `activityName`: 关联的活动名称
- `activityStartTime`: 活动开始时间
- `activityEndTime`: 活动结束时间
- `index`: 图片索引（用于排序）
- `description`: 图片描述

### 处理参数

- `maxWidth`: 最大宽度限制
- `maxHeight`: 最大高度限制
- `compress`: 是否压缩
- `quality`: 图片质量（1-100）
- `watermark`: 是否添加水印
- `allowResize`: 是否允许缩放

### 标签参数

- `tags`: 图片标签（逗号分隔）
- `originalName`: 原始文件名
- `priority`: 处理优先级

## 自定义参数示例

### 1. 添加用户权限验证参数

```typescript
const uploadParams = generateUploadParams('cover', {
  userId: userStore.info.userId,
  userRole: userStore.info.roles.join(','),
  permissions: 'upload,edit,delete'
})
```

### 2. 添加文件处理配置

```typescript
const uploadParams = generateUploadParams('display', {
  autoCompress: 'true',
  targetSize: '500KB',
  outputFormat: 'webp',
  enableThumbnail: 'true',
  thumbnailSize: '200x200'
})
```

### 3. 添加业务流程参数

```typescript
const uploadParams = generateUploadParams('cover', {
  workflowId: 'activity_creation_001',
  approvalRequired: 'true',
  notifyUsers: 'admin@example.com,manager@example.com',
  businessContext: JSON.stringify({
    module: 'activity',
    action: 'create',
    timestamp: Date.now()
  })
})
```

## 注意事项

1. **参数类型**: 所有参数最终会转换为字符串类型发送到服务器
2. **空值过滤**: 建议过滤掉 null、undefined 和空字符串值
3. **参数长度**: 注意FormData的大小限制，避免传递过长的参数
4. **敏感信息**: 不要在参数中传递敏感信息，如密码、token等
5. **服务器支持**: 确保后端接口支持接收这些额外参数

## 扩展建议

### 1. 创建参数配置文件

```typescript
// config/uploadParams.ts
export const UPLOAD_PARAMS_CONFIG = {
  activity: {
    cover: {
      maxWidth: '1920',
      maxHeight: '1080',
      compress: 'true',
      quality: '90'
    },
    display: {
      quality: '85',
      allowResize: 'true',
      generateThumbnail: 'true'
    }
  },
  article: {
    cover: {
      maxWidth: '1200',
      maxHeight: '800',
      watermark: 'true'
    }
  }
}
```

### 2. 创建参数验证函数

```typescript
const validateUploadParams = (params: Record<string, any>) => {
  const requiredFields = ['type', 'category', 'uploadTime']

  for (const field of requiredFields) {
    if (!params[field]) {
      throw new Error(`必需参数 ${field} 缺失`)
    }
  }

  return true
}
```

### 3. 创建参数日志记录

```typescript
const logUploadParams = (params: Record<string, any>) => {
  console.log('上传参数:', {
    timestamp: new Date().toISOString(),
    params: params,
    user: userStore.info.userName
  })
}
```

通过这种方式，您可以灵活地为图片上传功能添加各种业务参数，满足不同场景的需求。
